<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SAMEMO — Prépa Bac Tampon</title>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#0f766e">

<style>
:root{
  --primary:#0f766e;
  --success:#16a34a;
  --error:#dc2626;
  --bg:#f8fafc;
  --card:#ffffff;
  --border:#e5e7eb;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:var(--bg);
}
.app{max-width:480px;margin:auto;padding:16px}
.header{text-align:center;margin-bottom:12px}
.logo{font-size:28px;font-weight:900;color:var(--primary)}
.subtitle{font-size:14px;color:#475569}

.card{
  background:var(--card);
  border-radius:14px;
  padding:16px;
  margin-bottom:12px;
  box-shadow:0 8px 20px rgba(0,0,0,.06);
}
.list-item{border-bottom:1px solid var(--border);padding:12px 0}
button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
  font-weight:800;
  margin-top:10px;
}
.primary{background:var(--primary);color:#fff}
.success{background:var(--success);color:#fff}
.error{background:var(--error);color:#fff}
.hidden{display:none}
.center{text-align:center}
</style>
</head>

<body>

<div class="app">

  <div class="header">
    <div class="logo">SAMEMO</div>
    <div class="subtitle">Remplissage bac tampon</div>
  </div>

  <div id="message" class="card hidden center"></div>

  <!-- LISTE BACS -->
  <div id="bacsList" class="card">
    <h3>Bacs à compléter</h3>
    <div id="bacs"></div>
  </div>

  <!-- SCAN BAC -->
  <div id="scanBac" class="card hidden">
    <h3 class="center">Scanner le bac</h3>
    <div id="qr-bac" style="min-height:260px"></div>
  </div>

  <!-- SCAN PRODUIT -->
  <div id="scanProduct" class="card hidden">
    <h3 id="prodTitle" class="center"></h3>
    <div id="qr-product" style="min-height:260px"></div>
    <p id="counter" class="center"></p>
  </div>

</div>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbw4CJBufpFeLSzZvyOcbVA5fBIERBCppbKla-QMEQmZWXkY0ndBIAYAxGmm0nNXmqud/exec";

let bacsData=[];
let scanner=null;
let currentBac=null;
let qty=0;
let target=0;
let productCode=null;

/* LOAD BACS */
async function loadBacs(){
  const res = await fetch(API_URL+"?action=bacsTampon");
  const json = await res.json();
  bacsData = Array.isArray(json)?json:json.data||[];
  renderBacs();
}

function renderBacs(){
  const d=document.getElementById("bacs");
  d.innerHTML="";
  bacsData.forEach(b=>{
    const need=b.Qty_Having<b.Qty_Target;
    if(!need) return;
    d.innerHTML+=`
      <div class="list-item">
        <strong>${b.Bac_Code}</strong><br>
        ${b.Produit_Label}<br>
        ${b.Qty_Having} / ${b.Qty_Target}
        <button class="primary" onclick="scanBac('${b.Bac_Code}')">
          Scanner bac
        </button>
      </div>`;
  });
}

/* SCAN BAC */
function scanBac(code){
  currentBac=code;
  const b=bacsData.find(x=>x.Bac_Code===code);
  qty=b.Qty_Having;
  target=b.Qty_Target;
  productCode=b.Produit_Code;

  document.getElementById("bacsList").classList.add("hidden");
  document.getElementById("scanBac").classList.remove("hidden");

  scanner=new Html5Qrcode("qr-bac");
  scanner.start({facingMode:"environment"},{fps:10,qrbox:250},res=>{
    if(res===currentBac){
      scanner.stop();
      startProductScan();
    }
  });
}

/* SCAN PRODUIT */
function startProductScan(){
  document.getElementById("scanBac").classList.add("hidden");
  document.getElementById("scanProduct").classList.remove("hidden");

  document.getElementById("prodTitle").textContent=
    `Produit ${productCode}`;
  updateCounter();

  scanner=new Html5Qrcode("qr-product");
  scanner.start({facingMode:"environment"},{fps:10,qrbox:200},code=>{
    if(code===productCode){
      qty++;
      updateCounter();
      updateQty();

      if(qty>=target){
        scanner.stop();
        showMessage("✅ Bac rempli","success");
        setTimeout(()=>{
          location.reload();
        },1200);
      }
    }
  });
}

function updateCounter(){
  document.getElementById("counter").textContent=
    `Quantité : ${qty} / ${target}`;
}

/* UPDATE BACKEND */
async function updateQty(){
  await fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      action:"incrementBac",
      bac:currentBac
    })
  });
}

function showMessage(t,type){
  const m=document.getElementById("message");
  m.textContent=t;
  m.className="card "+type;
  m.classList.remove("hidden");
}

loadBacs();
</script>

</body>
</html>
