<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SAMEMO ‚Äî Pr√©pa Bac Tampon</title>

<style>
:root{
  --primary:#0f766e;
  --success:#16a34a;
  --error:#dc2626;
  --bg:#f8fafc;
  --card:#ffffff;
  --border:#e5e7eb;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:var(--bg);
}
.app{max-width:480px;margin:auto;padding:16px}
.header{text-align:center;margin-bottom:12px}
.logo{font-size:28px;font-weight:900;color:var(--primary)}
.subtitle{font-size:14px;color:#475569}

.card{
  background:var(--card);
  border-radius:14px;
  padding:16px;
  margin-bottom:12px;
  box-shadow:0 8px 20px rgba(0,0,0,.06);
}

.list-item{
  padding:12px 0;
  border-bottom:1px solid var(--border);
}
.list-item:last-child{border-bottom:none}

button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
  font-weight:800;
  margin-top:8px;
  cursor:pointer;
}
.primary{background:var(--primary);color:#fff}
.success{background:var(--success);color:#fff}
.error{background:var(--error);color:#fff}
.hidden{display:none}
.center{text-align:center}
</style>
</head>

<body>

<div class="app">

  <div class="header">
    <div class="logo">SAMEMO</div>
    <div class="subtitle">Pr√©paration ‚Äî Bacs Tampon</div>
  </div>

  <div id="message" class="card hidden center"></div>

  <!-- LISTE BACS -->
  <div id="screen-list" class="card">
    <h3>Bacs √† compl√©ter</h3>
    <div id="bacs"></div>
  </div>

  <!-- SCAN PRODUITS -->
  <div id="screen-fill" class="card hidden">
    <h3 id="bacTitle"></h3>
    <p id="bacInfo" class="center"></p>
    <button class="primary" onclick="scanProduct()">‚ûï Scanner produit</button>
    <button class="success hidden" id="finishBtn" onclick="finishBac()">‚úÖ Bac rempli</button>
  </div>

</div>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbw4CJBufpFeLSzZvyOcbVA5fBIERBCppbKla-QMEQmZWXkY0ndBIAYAxGmm0nNXmqud/exec";

/* ================= STATE ================= */
let bacs = [];
let currentBac = null;

/* ================= LOAD ================= */
async function loadBacs(){
  try{
    const res = await fetch(API_URL + "?action=bacsTampon");
    const data = await res.json();

    if(!Array.isArray(data)) throw "API invalide";

    bacs = data;
    renderBacs();

  }catch(e){
    console.error(e);
    showMessage("Erreur chargement bacs","error");
  }
}

/* ================= RENDER LIST ================= */
function renderBacs(){
  const div = document.getElementById("bacs");
  div.innerHTML = "";

  const todo = bacs.filter(b => Number(b.QTY_ACTUEL) < Number(b.QTY_MAX));

  if(todo.length === 0){
    div.innerHTML = "<em>Aucun bac √† compl√©ter üëç</em>";
    return;
  }

  todo.forEach(b=>{
    const d = document.createElement("div");
    d.className = "list-item";
    d.innerHTML = `
      <strong>${b.BAC_ID}</strong><br>
      ${b.PRODUIT_NOM}<br>
      ${b.QTY_ACTUEL} / ${b.QTY_MAX}
      <button class="primary" onclick="openBac('${b.BAC_ID}')">
        üì¶ Ouvrir le bac
      </button>
    `;
    div.appendChild(d);
  });
}

/* ================= OPEN BAC ================= */
function openBac(id){
  currentBac = bacs.find(b => b.BAC_ID === id);

  document.getElementById("screen-list").classList.add("hidden");
  document.getElementById("screen-fill").classList.remove("hidden");

  updateBacUI();
}

/* ================= UI UPDATE ================= */
function updateBacUI(){
  document.getElementById("bacTitle").textContent =
    "Bac " + currentBac.BAC_ID;

  document.getElementById("bacInfo").textContent =
    currentBac.PRODUIT_NOM + " ‚Äî " +
    currentBac.QTY_ACTUEL + " / " + currentBac.QTY_MAX;

  if(Number(currentBac.QTY_ACTUEL) >= Number(currentBac.QTY_MAX)){
    document.getElementById("finishBtn").classList.remove("hidden");
  }
}

/* ================= SCAN PRODUIT ================= */
async function scanProduct(){
  if(currentBac.QTY_ACTUEL >= currentBac.QTY_MAX) return;

  currentBac.QTY_ACTUEL++;

  await fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      action:"incrementBac",
      bac: currentBac.BAC_ID
    })
  });

  updateBacUI();
}

/* ================= FIN ================= */
function finishBac(){
  document.getElementById("screen-fill").classList.add("hidden");
  document.getElementById("screen-list").classList.remove("hidden");
  loadBacs();
}

/* ================= MESSAGE ================= */
function showMessage(txt,type){
  const m=document.getElementById("message");
  m.textContent=txt;
  m.className="card "+type;
  m.classList.remove("hidden");
  setTimeout(()=>m.classList.add("hidden"),2500);
}

/* ================= INIT ================= */
loadBacs();
</script>

</body>
</html>
