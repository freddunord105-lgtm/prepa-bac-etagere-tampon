<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SAMEMO ‚Äî Pr√©pa Bac Tampon</title>
<meta name="theme-color" content="#0f766e">
<link rel="manifest" href="/manifest.json">

<style>
:root{
  --primary:#0f766e;
  --success:#16a34a;
  --warning:#f59e0b;
  --error:#dc2626;
  --bg:#f8fafc;
  --card:#ffffff;
  --border:#e5e7eb;
  --muted:#64748b;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
  background:var(--bg);
}
.app{max-width:520px;margin:auto;padding:16px}
.header{
  text-align:center;
  margin-bottom:12px;
}
.logo{
  font-size:28px;
  font-weight:900;
  color:var(--primary);
  letter-spacing:.6px;
}
.subtitle{font-size:14px;color:var(--muted)}
.card{
  background:var(--card);
  border-radius:14px;
  padding:16px;
  margin-bottom:12px;
  box-shadow:0 10px 24px rgba(0,0,0,.06);
}
.row{display:flex;gap:10px;align-items:center;justify-content:space-between}
.h3{margin:0 0 10px 0}
.small{font-size:13px;color:var(--muted)}
.list-item{
  padding:12px 0;
  border-bottom:1px solid var(--border);
}
.list-item:last-child{border-bottom:none}
.badge{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:800;
}
.badge.low{background:#fee2e2;color:#b91c1c}
.badge.ok{background:#dcfce7;color:#15803d}
.badge.info{background:#e0f2fe;color:#075985}
button{
  width:100%;
  padding:12px 14px;
  border:none;
  border-radius:12px;
  font-weight:900;
  cursor:pointer;
  margin-top:10px;
}
.primary{background:var(--primary);color:#fff}
.success{background:var(--success);color:#fff}
.warning{background:var(--warning);color:#111827}
.danger{background:var(--error);color:#fff}
.ghost{
  background:#fff;
  border:1px solid var(--border);
  color:#0f172a;
}
.hidden{display:none}
.center{text-align:center}
.big{
  font-size:22px;
  font-weight:900;
}
.hr{height:1px;background:var(--border);margin:12px 0}
.kpi{
  display:flex;gap:10px;justify-content:space-between;margin-top:8px
}
.kpi > div{
  flex:1;
  background:#f8fafc;
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
}
.kpi .label{font-size:12px;color:var(--muted);font-weight:800}
.kpi .value{font-size:18px;font-weight:900;color:#0f172a}
#qr-reader, #qr-reader-product{width:100%;min-height:260px}
.note{
  padding:10px;
  border-radius:12px;
  background:#f8fafc;
  border:1px dashed var(--border);
  color:#0f172a;
  font-weight:700;
}
</style>
</head>

<body>
<div class="app">

  <div class="header">
    <div class="logo">SAMEMO</div>
    <div class="subtitle">Pr√©paration ‚Äî Bacs Tampon</div>
  </div>

  <!-- message toast -->
  <div id="toast" class="card hidden center"></div>

  <!-- LISTE -->
  <div id="screen-list" class="card">
    <div class="row">
      <div>
        <div class="h3 big">Bacs √† compl√©ter</div>
        <div class="small">Clique un bac ‚Üí valide en scannant ‚Üí scan produits jusqu‚Äôau max.</div>
      </div>
      <button class="ghost" style="width:auto;margin:0;padding:10px 12px" onclick="loadBacs()">‚Üª</button>
    </div>
    <div class="hr"></div>
    <div id="bacs"></div>
  </div>

  <!-- SCAN BAC -->
  <div id="screen-scan-bac" class="card hidden">
    <div class="row">
      <div class="big">Scanner le bac</div>
      <button class="ghost" style="width:auto;margin:0;padding:10px 12px" id="btnBackFromBac">‚¨Ö</button>
    </div>
    <div class="small" id="bacHint" style="margin-top:6px"></div>
    <div class="hr"></div>

    <button id="btnStartBacScan" class="primary" type="button">üì∑ D√©marrer cam√©ra</button>
    <div id="qr-reader" class="hidden" style="margin-top:10px"></div>
    <div id="bacScanResult" class="center" style="margin-top:10px;font-weight:900"></div>

    <div class="hr"></div>
    <div class="note small">
      Si la cam√©ra est refus√©e, tu reviens √† la liste automatiquement.
    </div>
  </div>

  <!-- SCAN PRODUITS -->
  <div id="screen-scan-product" class="card hidden">
    <div class="row">
      <div class="big">Remplir le bac</div>
      <button class="ghost" style="width:auto;margin:0;padding:10px 12px" id="btnBackFromProduct">‚¨Ö</button>
    </div>

    <div class="hr"></div>

    <div class="note" id="productInfo"></div>

    <div class="kpi">
      <div>
        <div class="label">Actuel</div>
        <div class="value" id="kpiHaving">0</div>
      </div>
      <div>
        <div class="label">Cible</div>
        <div class="value" id="kpiTarget">0</div>
      </div>
      <div>
        <div class="label">√Ä ajouter</div>
        <div class="value" id="kpiNeed">0</div>
      </div>
    </div>

    <button id="btnStartProductScan" class="primary" type="button" style="margin-top:12px">üì∑ Scanner produits</button>
    <div id="qr-reader-product" class="hidden" style="margin-top:10px"></div>

    <div id="productScanMsg" class="center" style="margin-top:10px;font-weight:900"></div>

    <button id="btnFinish" class="success hidden" type="button">‚úÖ Valider bac rempli</button>
  </div>

</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbw4CJBufpFeLSzZvyOcbVA5fBIERBCppbKla-QMEQmZWXkY0ndBIAYAxGmm0nNXmqud/exec";

/* ================= STATE ================= */
let bacsData = [];
let currentBacObj = null;

let bacScanner = null;
let bacScannerRunning = false;

let productScanner = null;
let productScannerRunning = false;

let needToAdd = 0;     // quantit√© √† ajouter (pour arriver √† qtyMax)
let addedCount = 0;    // nombre de scans valid√©s
let lastScan = {code:null, time:0};
const COOLDOWN_MS = 900;

/* ================= UI HELPERS ================= */
const $ = (id) => document.getElementById(id);

function toast(msg, type="success"){
  const t = $("toast");
  t.textContent = msg;
  t.className = "card center";
  t.style.border = "1px solid var(--border)";
  if(type==="success") t.style.background = "#ecfdf5";
  if(type==="error")   t.style.background = "#fee2e2";
  if(type==="info")    t.style.background = "#e0f2fe";
  t.classList.remove("hidden");
  setTimeout(()=>t.classList.add("hidden"), 2200);
}

function showScreen(which){
  $("screen-list").classList.add("hidden");
  $("screen-scan-bac").classList.add("hidden");
  $("screen-scan-product").classList.add("hidden");
  $(which).classList.remove("hidden");
}

/* ================= LOAD BACS ================= */
async function loadBacs(){
  try{
    const res = await fetch(API_URL + "?action=bacsTampon", { cache:"no-store" });
    const json = await res.json();

    // accepte: [ ... ] ou { data:[ ... ] }
    if(Array.isArray(json)) bacsData = json;
    else if(json && Array.isArray(json.data)) bacsData = json.data;
    else {
      console.warn("R√©ponse API invalide:", json);
      bacsData = [];
      toast("API invalide", "error");
    }

    renderBacs();

  }catch(err){
    console.error(err);
    bacsData = [];
    renderBacs();
    toast("Erreur API", "error");
  }
}

function renderBacs(){
  const div = $("bacs");
  div.innerHTML = "";

  if(!Array.isArray(bacsData) || bacsData.length === 0){
    div.innerHTML = "<em>Aucun bac √† compl√©ter üëç</em>";
    return;
  }

  bacsData.forEach(b=>{
    // compat champs
    const bacId     = b.BAC_ID ?? b.Bac_Code ?? "BAC-?";
    const qrCode    = b.QR_CODE ?? bacId; // IMPORTANT
    const prodCode  = b.PRODUIT_CODE ?? b.Product_Code ?? "";
    const prodName  = b.PRODUIT_NOM ?? b.Produit_Label ?? "Produit";
    const qtyHaving = Number(b.QTY_ACTUEL ?? b.Qty_Having ?? 0);
    const qtyMax    = Number(b.QTY_MAX ?? b.Qty_Target ?? 0);

    const needFill  = qtyHaving < qtyMax;

    const item = document.createElement("div");
    item.className = "list-item";
    item.innerHTML = `
      <div class="row">
        <div>
          <div style="font-weight:900">${bacId} <span class="badge ${needFill?'low':'ok'}">${needFill?'√Ä remplir':'OK'}</span></div>
          <div class="small">${prodName} <span class="badge info">${prodCode || "CODE?"}</span></div>
          <div class="small" style="margin-top:4px">${qtyHaving} / ${qtyMax}</div>
        </div>
      </div>
      <button class="primary" type="button">üì∑ Scanner ce bac</button>
    `;

    item.querySelector("button").onclick = () => {
      currentBacObj = { bacId, qrCode, prodCode, prodName, qtyHaving, qtyMax };
      openBacScan();
    };

    div.appendChild(item);
  });
}

/* ================= SCAN BAC ================= */
function openBacScan(){
  stopProductScannerSafe();
  stopBacScannerSafe();

  $("bacScanResult").textContent = "";
  $("qr-reader").classList.add("hidden");
  $("btnStartBacScan").classList.remove("hidden");

  $("bacHint").textContent =
    `Bac attendu : ${currentBacObj.bacId} (QR : ${currentBacObj.qrCode})`;

  showScreen("screen-scan-bac");
}

$("btnStartBacScan").onclick = async () => {
  // demande permission AVANT html5-qrcode (sinon erreurs en cha√Æne)
  try{
    await navigator.mediaDevices.getUserMedia({ video:true });
  }catch(err){
    toast("üì∑ Cam√©ra refus√©e ‚Äî retour liste", "error");
    showScreen("screen-list");
    return;
  }

  $("btnStartBacScan").classList.add("hidden");
  $("qr-reader").classList.remove("hidden");

  bacScanner = new Html5Qrcode("qr-reader");
  bacScannerRunning = false;

  bacScanner.start(
    { facingMode:"environment" },
    { fps:10, qrbox:250 },
    (codeText) => onBacScanned(codeText),
    () => {}
  ).then(()=> {
    bacScannerRunning = true;
  }).catch((err)=> {
    console.warn("Start bac scan failed:", err);
    bacScannerRunning = false;
    toast("üì∑ Cam√©ra indisponible", "error");
    showScreen("screen-list");
  });
};

function onBacScanned(codeText){
  const now = Date.now();
  if(codeText === lastScan.code && (now-lastScan.time) < COOLDOWN_MS) return;
  lastScan = {code:codeText, time:now};

  const expectedId = String(currentBacObj.bacId);
  const expectedQr = String(currentBacObj.qrCode);

  // accepte scan == BAC_ID ou QR_CODE
  if(codeText !== expectedId && codeText !== expectedQr){
    $("bacScanResult").textContent = "‚ùå Mauvais bac : " + codeText;
    $("bacScanResult").style.color = "#dc2626";
    return;
  }

  $("bacScanResult").textContent = "‚úÖ Bac valid√© : " + expectedId;
  $("bacScanResult").style.color = "#16a34a";

  stopBacScannerSafe();
  openProductScan();
}

function stopBacScannerSafe(){
  if(bacScanner && bacScannerRunning){
    bacScanner.stop().catch(()=>{}).finally(()=>{ bacScannerRunning = false; });
  }else{
    bacScannerRunning = false;
  }
  // on ne clear pas le div, sinon html5-qrcode peut replanter sur iOS
}

/* ================= SCAN PRODUITS ================= */
function openProductScan(){
  stopProductScannerSafe();

  const { bacId, prodCode, prodName, qtyHaving, qtyMax } = currentBacObj;

  needToAdd = Math.max(0, qtyMax - qtyHaving);
  addedCount = 0;

  $("productInfo").innerHTML = `
    <div style="font-weight:900">Bac : ${bacId}</div>
    <div class="small">Produit attendu : <b>${prodName}</b> (<b>${prodCode || "CODE?"}</b>)</div>
    <div class="small">Scanne le produit jusqu‚Äô√† atteindre la cible.</div>
  `;

  $("kpiHaving").textContent = qtyHaving;
  $("kpiTarget").textContent = qtyMax;
  $("kpiNeed").textContent = needToAdd;

  $("productScanMsg").textContent = "";
  $("productScanMsg").style.color = "#0f172a";

  $("btnFinish").classList.add("hidden");
  $("qr-reader-product").classList.add("hidden");
  $("btnStartProductScan").classList.remove("hidden");

  showScreen("screen-scan-product");
}

$("btnStartProductScan").onclick = async () => {
  if(needToAdd <= 0){
    $("productScanMsg").textContent = "‚úÖ D√©j√† au max, rien √† ajouter.";
    $("productScanMsg").style.color = "#16a34a";
    $("btnFinish").classList.remove("hidden");
    return;
  }

  try{
    await navigator.mediaDevices.getUserMedia({ video:true });
  }catch(err){
    toast("üì∑ Cam√©ra refus√©e ‚Äî retour liste", "error");
    showScreen("screen-list");
    return;
  }

  $("btnStartProductScan").classList.add("hidden");
  $("qr-reader-product").classList.remove("hidden");

  productScanner = new Html5Qrcode("qr-reader-product");
  productScannerRunning = false;

  productScanner.start(
    { facingMode:"environment" },
    { fps:10, qrbox:250 },
    (codeText) => onProductScanned(codeText),
    () => {}
  ).then(()=>{
    productScannerRunning = true;
  }).catch((err)=>{
    console.warn("Start product scan failed:", err);
    productScannerRunning = false;
    toast("üì∑ Cam√©ra indisponible", "error");
    showScreen("screen-list");
  });
};

function onProductScanned(codeText){
  const now = Date.now();
  if(codeText === lastScan.code && (now-lastScan.time) < COOLDOWN_MS) return;
  lastScan = {code:codeText, time:now};

  const expectedProd = String(currentBacObj.prodCode || "");
  if(!expectedProd){
    $("productScanMsg").textContent = "‚ö†Ô∏è Bac sans PRODUIT_CODE (sheet incomplet).";
    $("productScanMsg").style.color = "#f59e0b";
    return;
  }

  if(codeText !== expectedProd){
    $("productScanMsg").textContent = "‚ùå Mauvais produit : " + codeText;
    $("productScanMsg").style.color = "#dc2626";
    return;
  }

  if(addedCount >= needToAdd){
    $("productScanMsg").textContent = "‚úÖ D√©j√† complet.";
    $("productScanMsg").style.color = "#16a34a";
    return;
  }

  addedCount++;
  const newHaving = currentBacObj.qtyHaving + addedCount;
  const remaining = Math.max(0, currentBacObj.qtyMax - newHaving);

  $("kpiHaving").textContent = newHaving;
  $("kpiNeed").textContent = remaining;

  $("productScanMsg").textContent = `‚úÖ OK (${addedCount}/${needToAdd})`;
  $("productScanMsg").style.color = "#16a34a";

  if(remaining === 0){
    stopProductScannerSafe();
    $("btnFinish").classList.remove("hidden");
    $("productScanMsg").textContent = "‚úÖ Bac rempli ‚Äî valide pour enregistrer.";
  }
}

function stopProductScannerSafe(){
  if(productScanner && productScannerRunning){
    productScanner.stop().catch(()=>{}).finally(()=>{ productScannerRunning = false; });
  }else{
    productScannerRunning = false;
  }
}

/* ================= FINISH (POST updateBac) ================= */
/* ‚úÖ CORRIG√â CORS : POST "simple" form-urlencoded (pas JSON, pas headers) */
$("btnFinish").onclick = async () => {
  try{
    const body = new URLSearchParams();
    body.set("action", "updateBac");
    body.set("bac", currentBacObj.bacId);
    body.set("qtyAdded", String(addedCount));

    const res = await fetch(API_URL, {
      method: "POST",
      body: body
    });

    const txt = await res.text();
    let r = {};
    try { r = JSON.parse(txt); }
    catch(e){ r = { success:false, error:"R√©ponse non JSON", raw: txt }; }

    if(r && r.success === false){
      toast("‚ùå " + (r.error || "Erreur serveur"), "error");
      return;
    }

    toast("‚úÖ Bac mis √† jour", "success");
    currentBacObj = null;
    showScreen("screen-list");
    loadBacs();

  }catch(err){
    console.error(err);
    toast("Erreur mise √† jour", "error");
  }
};

/* ================= BACK BUTTONS ================= */
$("btnBackFromBac").onclick = () => {
  stopBacScannerSafe();
  showScreen("screen-list");
};

$("btnBackFromProduct").onclick = () => {
  stopProductScannerSafe();
  showScreen("screen-list");
};

/* ================= INIT ================= */
loadBacs();
</script>

</body>
</html>
