<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SAMEMO — Bac Tampon</title>

<style>
:root{
  --primary:#0f766e;
  --success:#16a34a;
  --error:#dc2626;
  --bg:#f8fafc;
  --card:#ffffff;
  --border:#e5e7eb;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:var(--bg);
}
.app{max-width:480px;margin:auto;padding:16px}
.card{
  background:var(--card);
  border-radius:14px;
  padding:16px;
  margin-bottom:12px;
  box-shadow:0 6px 16px rgba(0,0,0,.06);
}
button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
  font-weight:800;
  background:var(--primary);
  color:#fff;
  margin-top:8px;
}
.hidden{display:none}
.badge{
  padding:4px 8px;
  border-radius:8px;
  font-size:12px;
  font-weight:700;
}
.low{background:#fee2e2;color:#b91c1c}
.ok{background:#dcfce7;color:#15803d}
.center{text-align:center}
</style>
</head>

<body>
<div class="app">

<div class="card center">
  <h2>SAMEMO</h2>
  <div>Préparation bacs tampon</div>
</div>

<div id="message" class="card hidden center"></div>

<!-- LISTE BACS -->
<div id="bacsList" class="card">
  <h3>Bacs à remplir</h3>
  <div id="bacs"></div>
</div>

<!-- SCAN -->
<div id="scanScreen" class="card hidden">
  <h3 id="scanTitle" class="center"></h3>
  <div id="qr-reader" style="width:100%;min-height:260px"></div>
  <div id="scanInfo" class="center" style="margin-top:10px;font-weight:700"></div>
  <button id="backBtn">⬅ Retour</button>
</div>

</div>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbw4CJBufpFeLSzZvyOcbVA5fBIERBCppbKla-QMEQmZWXkY0ndBIAYAxGmm0nNXmqud/exec";

/* ================= STATE ================= */
let bacsData = [];
let scanner = null;
let scannerRunning = false;
let currentBac = null;
let qty = 0;
let qtyTarget = 0;
let mode = "BAC";

/* ================= MESSAGE ================= */
function showMessage(txt,type){
  const m=document.getElementById("message");
  m.textContent=txt;
  m.className="card "+type;
  m.classList.remove("hidden");
  setTimeout(()=>m.classList.add("hidden"),2000);
}

/* ================= SAFE STOP ================= */
function safeStopScanner(){
  if(scanner && scannerRunning){
    scanner.stop()
      .then(()=>{ scannerRunning=false; })
      .catch(()=>{});
  }
}

/* ================= LOAD BACS ================= */
async function loadBacs(){
  try{
    const res = await fetch(API_URL+"?action=bacsTampon");
    const json = await res.json();
    bacsData = Array.isArray(json) ? json : (json.data || []);
    renderBacs();
  }catch{
    showMessage("Erreur API","error");
  }
}

/* ================= RENDER ================= */
function renderBacs(){
  const div=document.getElementById("bacs");
  div.innerHTML="";
  if(bacsData.length===0){
    div.innerHTML="<em>Aucun bac à remplir</em>";
    return;
  }

  bacsData.forEach(b=>{
    const need=b.Qty_Having<b.Qty_Target;
    div.innerHTML+=`
      <div style="margin-bottom:10px">
        <strong>${b.Bac_Code}</strong><br>
        ${b.Produit_Label}<br>
        ${b.Qty_Having} / ${b.Qty_Target}
        <span class="badge ${need?'low':'ok'}">${need?'À remplir':'OK'}</span>
        <button onclick="startBacScan('${b.Bac_Code}',${b.Qty_Having},${b.Qty_Target})">
          Scanner bac
        </button>
      </div>`;
  });
}

/* ================= START BAC ================= */
function startBacScan(code,have,target){
  currentBac=code;
  qty=have;
  qtyTarget=target;
  mode="BAC";

  document.getElementById("bacsList").classList.add("hidden");
  document.getElementById("scanScreen").classList.remove("hidden");
  document.getElementById("scanTitle").textContent="Scanner le bac";
  document.getElementById("scanInfo").textContent="";

  startScanner();
}

/* ================= START SCANNER ================= */
function startScanner(){
  scanner = new Html5Qrcode("qr-reader");
  scannerRunning = false;

  scanner.start(
    { facingMode:"environment" },
    { fps:10, qrbox:250 },
    onScan,
    ()=>{}
  ).then(()=>{
    scannerRunning = true;
  }).catch(()=>{
    showMessage("Caméra refusée","error");
    back();
  });
}

/* ================= ON SCAN ================= */
function onScan(code){
  if(mode==="BAC"){
    if(code!==currentBac) return;

    safeStopScanner();
    mode="PRODUIT";

    document.getElementById("scanTitle").textContent="Scanner les produits";
    document.getElementById("scanInfo").textContent=`${qty} / ${qtyTarget}`;

    startScanner();
  }
  else if(mode==="PRODUIT"){
    qty++;
    document.getElementById("scanInfo").textContent=`${qty} / ${qtyTarget}`;

    fetch(API_URL,{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        action:"scanProduit",
        bac:currentBac,
        produit:code
      })
    });

    if(qty>=qtyTarget){
      safeStopScanner();
      showMessage("Bac rempli ✅","success");
      setTimeout(()=>{
        back();
        loadBacs();
      },1200);
    }
  }
}

/* ================= BACK ================= */
function back(){
  safeStopScanner();
  document.getElementById("scanScreen").classList.add("hidden");
  document.getElementById("bacsList").classList.remove("hidden");
}

document.getElementById("backBtn").onclick=back;

/* ================= INIT ================= */
loadBacs();
</script>

</body>
</html>
